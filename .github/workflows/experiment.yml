# Workflow for testing experiments
# Tests the malloc hooks experiment on Linux, Windows, and macOS

name: Experiments

on:
  push:
    branches: [main, master]
    paths:
      - 'experiments/**'
      - '.github/workflows/experiment.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'experiments/**'
      - '.github/workflows/experiment.yml'
  workflow_dispatch:

jobs:
  malloc-hooks:
    name: Malloc Hooks (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: gcc
          - os: windows-latest
            compiler: clang
          - os: macos-latest
            compiler: clang

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build zlib1g-dev python3

      - name: Setup Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja coreutils zlib python3

      - name: Remove system LLVM (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path "C:\Program Files\LLVM") {
            Remove-Item -Path "C:\Program Files\LLVM" -Recurse -Force
          }

      - name: Install LLVM-MinGW (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "20241217"
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/$version/llvm-mingw-$version-ucrt-x86_64.zip"
          Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\llvm-mingw.zip"
          Expand-Archive -Path "$env:TEMP\llvm-mingw.zip" -DestinationPath "C:\llvm-mingw" -Force
          $llvmDir = Get-ChildItem -Path "C:\llvm-mingw" -Directory | Select-Object -First 1
          echo "$($llvmDir.FullName)\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ninja -y

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Test-Path "C:\vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          }
          if (-not (Test-Path "C:\vcpkg\vcpkg.exe")) {
            & "C:\vcpkg\bootstrap-vcpkg.bat" -disableMetrics
          }
          & "C:\vcpkg\vcpkg.exe" install zlib:x64-windows --classic
          echo "VCPKG_ROOT=C:\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build main compiler
        shell: bash
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_C_COMPILER=${{ matrix.compiler }} -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Build experiment
        working-directory: experiments/malloc
        shell: bash
        run: make build

      - name: Run test (Linux)
        if: runner.os == 'Linux'
        working-directory: experiments/malloc
        run: make test

      - name: Run test (macOS)
        if: runner.os == 'macOS'
        working-directory: experiments/malloc
        run: |
          ZLIB_PREFIX=$(brew --prefix zlib)
          export SN_CFLAGS="-g -I${ZLIB_PREFIX}/include"
          export SN_LDFLAGS="-L${ZLIB_PREFIX}/lib"
          make test

      - name: Run test (Windows)
        if: runner.os == 'Windows'
        working-directory: experiments/malloc
        shell: pwsh
        run: make test
