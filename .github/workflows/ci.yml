# Unified CI/CD workflow for Sindarin Compiler
# Builds and tests on Linux, Windows, and macOS using the same Make targets
# developers use locally (make setup, make build, make test-*).

name: CI

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [main, master, develop]
    paths-ignore:
      - 'docs/**'
      - '*.md'
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: sn-linux-x64
            exe_ext: ''
            runtime_dir: gcc
            sn_cc: gcc
            sn_cflags: ''
            sn_exclude_tests: ''

          - os: windows-latest
            artifact_name: sn-windows-x64
            exe_ext: '.exe'
            runtime_dir: clang
            sn_cc: clang
            sn_cflags: '--target=x86_64-w64-mingw32 -fuse-ld=lld -rtlib=compiler-rt -unwindlib=none'
            sn_exclude_tests: ''

          - os: macos-latest
            artifact_name: sn-macos-x64
            exe_ext: ''
            runtime_dir: gcc
            sn_cc: clang
            sn_cflags: ''
            sn_exclude_tests: 'test_thread_panic_propagate'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      #------------------------------------------------------------------------
      # Platform Pre-steps (minimal: ensure make, C compiler, python exist)
      #------------------------------------------------------------------------
      - name: Setup Prerequisites (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3

      - name: Setup Prerequisites (macOS)
        if: runner.os == 'macOS'
        run: brew install python3

      - name: Remove system LLVM (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path "C:\Program Files\LLVM") {
            Write-Host "Removing system LLVM to avoid conflicts..."
            Remove-Item -Path "C:\Program Files\LLVM" -Recurse -Force
          }

      - name: Install LLVM-MinGW (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "20241217"
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/$version/llvm-mingw-$version-ucrt-x86_64.zip"
          $zipPath = "$env:TEMP\llvm-mingw.zip"
          $extractPath = "C:\llvm-mingw"

          Write-Host "Downloading LLVM-MinGW $version..."
          Invoke-WebRequest -Uri $url -OutFile $zipPath

          Write-Host "Extracting to $extractPath..."
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

          $llvmDir = Get-ChildItem -Path $extractPath -Directory | Select-Object -First 1
          $binPath = Join-Path $llvmDir.FullName "bin"

          Write-Host "LLVM-MinGW installed at: $($llvmDir.FullName)"
          echo "$binPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Make and Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install make ninja -y

      #------------------------------------------------------------------------
      # Unified Build Steps (same for all platforms)
      #------------------------------------------------------------------------
      # libs submodule provides pre-built libraries (fetched during checkout)
      # CMake will automatically detect and use them - no vcpkg build needed
      - name: Verify libs submodule
        shell: bash
        run: |
          if [ -d "libs/libs" ]; then
            echo "libs submodule found - using pre-built libraries"
            ls -la libs/libs/
          else
            echo "WARNING: libs submodule not found, falling back to vcpkg"
            make setup
          fi

      - name: Build
        shell: bash
        run: make build

      - name: Verify build outputs
        shell: bash
        run: |
          echo "Checking for compiler executable..."
          if [ ! -f "bin/sn${{ matrix.exe_ext }}" ]; then
            echo "ERROR: bin/sn${{ matrix.exe_ext }} not found"
            exit 1
          fi
          echo "Found: bin/sn${{ matrix.exe_ext }}"

          echo "Checking for test executable..."
          if [ ! -f "bin/tests${{ matrix.exe_ext }}" ]; then
            echo "ERROR: bin/tests${{ matrix.exe_ext }} not found"
            exit 1
          fi
          echo "Found: bin/tests${{ matrix.exe_ext }}"

          echo "Checking for runtime library..."
          if [ ! -f "bin/lib/${{ matrix.runtime_dir }}/libsn_runtime.a" ]; then
            echo "ERROR: bin/lib/${{ matrix.runtime_dir }}/libsn_runtime.a not found"
            exit 1
          fi
          echo "Found: bin/lib/${{ matrix.runtime_dir }}/libsn_runtime.a"

          echo ""
          echo "Build outputs verified successfully!"

      #------------------------------------------------------------------------
      # Run Tests (same make targets for all platforms, env vars handle differences)
      #------------------------------------------------------------------------
      - name: Run unit tests
        shell: bash
        run: make test-unit

      - name: Run integration tests
        shell: bash
        env:
          SN_CC: ${{ matrix.sn_cc }}
          SN_CFLAGS: ${{ matrix.sn_cflags }}
          SN_EXCLUDE_TESTS: ${{ matrix.sn_exclude_tests }}
        run: make test-integration

      - name: Run integration error tests
        shell: bash
        env:
          SN_CC: ${{ matrix.sn_cc }}
          SN_CFLAGS: ${{ matrix.sn_cflags }}
        run: make test-integration-errors

      - name: Run exploratory tests
        shell: bash
        env:
          SN_CC: ${{ matrix.sn_cc }}
          SN_CFLAGS: ${{ matrix.sn_cflags }}
        run: make test-explore

      - name: Run exploratory error tests
        shell: bash
        env:
          SN_CC: ${{ matrix.sn_cc }}
          SN_CFLAGS: ${{ matrix.sn_cflags }}
        run: make test-explore-errors

      - name: Run SDK tests
        shell: bash
        env:
          SN_CC: ${{ matrix.sn_cc }}
          SN_CFLAGS: ${{ matrix.sn_cflags }}
        run: make test-sdk

      - name: Run managed arena tests
        shell: bash
        run: make test-arena ${{ runner.os == 'Windows' && 'ARENA_SANITIZE=' || '' }}

      #------------------------------------------------------------------------
      # Upload Artifacts
      #------------------------------------------------------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            bin/sn${{ matrix.exe_ext }}
            bin/tests${{ matrix.exe_ext }}
            bin/lib/${{ matrix.runtime_dir }}/libsn_runtime.a
            bin/include/**/*
            bin/*.cfg
          retention-days: 7
