# Test: Insert and remove layers in a 3D struct array and GC

@alias "rt_arena_v2_gc"
native fn gc_collect(arena): int

struct Entry =>
    key: str
    value: str

fn buildModified(): Entry[][][] =>
    var r1: Entry[] = { Entry { key: "a", value: "1" } }
    var r2: Entry[] = { Entry { key: "c", value: "3" } }
    var l1: Entry[][] = { r1 }
    var l2: Entry[][] = { r2 }
    var cube: Entry[][][] = { l1, l2 }

    # Insert new layer at index 1
    var r_new: Entry[] = { Entry { key: "b", value: "2" } }
    var l_new: Entry[][] = { r_new }
    cube.insert(l_new, 1)

    # Remove first layer
    cube.remove(0)
    return cube

fn main(): void =>
    var cube: Entry[][][] = buildModified()
    gc_collect()

    if cube.length != 2 =>
        print($"FAIL: length {cube.length}\n")
        return
    if cube[0][0][0].key != "b" || cube[0][0][0].value != "2" =>
        print("FAIL: [0][0][0]\n")
        return
    if cube[1][0][0].key != "c" || cube[1][0][0].value != "3" =>
        print("FAIL: [1][0][0]\n")
        return
    print("PASS\n")
