// Test SDK compression module

import "../../sdk/zlib" as zlib

fn test_basic_compress_decompress(): void =>
    print("test_basic_compress_decompress: ")

    // Original data - "Hello, World!"
    var original: byte[] = {72, 101, 108, 108, 111, 44, 32, 87, 111, 114, 108, 100, 33}

    // Compress
    var compressed: byte[] = zlib.compress_data(original)
    assert(compressed.length > 0, "Compression should produce output")

    // Decompress
    var decompressed: byte[] = zlib.decompress_data(compressed, original.length)
    assert(decompressed.length == original.length, "Decompressed size should match original")

    // Verify content matches
    var i: int = 0
    while i < original.length =>
        assert(decompressed[i] == original[i], "Decompressed content should match original")
        i = i + 1

    print("PASS\n")

fn test_compress_levels(): void =>
    print("test_compress_levels: ")

    // Use a repeated pattern that compresses well - 20 'A's
    var data: byte[] = {65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65}

    // Test different compression levels
    var fast: byte[] = zlib.compress_data_level(data, zlib.ZLIB_BEST_SPEED())
    var best: byte[] = zlib.compress_data_level(data, zlib.ZLIB_BEST_COMPRESSION())
    var default_level: byte[] = zlib.compress_data(data)

    assert(fast.length > 0, "Fast compression should work")
    assert(best.length > 0, "Best compression should work")
    assert(default_level.length > 0, "Default compression should work")

    // All should decompress correctly
    var dec_fast: byte[] = zlib.decompress_data(fast, 20)
    var dec_best: byte[] = zlib.decompress_data(best, 20)
    var dec_default: byte[] = zlib.decompress_data(default_level, 20)

    assert(dec_fast.length == 20, "Fast decompression should restore size")
    assert(dec_best.length == 20, "Best decompression should restore size")
    assert(dec_default.length == 20, "Default decompression should restore size")

    print("PASS\n")

fn test_compress_to_buffer(): void =>
    print("test_compress_to_buffer: ")

    var original: byte[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10}

    // Get max size needed
    var max_size: int = zlib.max_compressed_size(original.length)
    var buffer: byte[max_size]

    // Compress into buffer
    var written: int = zlib.compress_to(original, buffer)
    assert(written > 0, "compress_to should return bytes written")
    assert(written <= max_size, "Written bytes should not exceed buffer")

    // Decompress from buffer
    var dest: byte[10]
    var read: int = zlib.decompress_to(buffer[0..written], dest)
    assert(read == 10, "Should decompress all 10 bytes")

    // Verify content
    var i: int = 0
    while i < 10 =>
        assert(dest[i] == original[i], "Decompressed content should match")
        i = i + 1

    print("PASS\n")

fn test_empty_data(): void =>
    print("test_empty_data: ")

    var empty: byte[0]
    var compressed: byte[] = zlib.compress_data(empty)
    assert(compressed.length == 0, "Empty input should produce empty output")

    print("PASS\n")

fn test_is_compressed(): void =>
    print("test_is_compressed: ")

    // Compress some data
    var original: byte[] = {1, 2, 3, 4, 5}
    var compressed: byte[] = zlib.compress_data(original)

    // Compressed data should be detected
    assert(zlib.is_compressed(compressed), "Compressed data should be detected")

    // Original data should not be detected as compressed
    assert(!zlib.is_compressed(original), "Uncompressed data should not be detected")

    // Empty and short data
    var empty: byte[0]
    var one: byte[] = {1}
    assert(!zlib.is_compressed(empty), "Empty data is not compressed")
    assert(!zlib.is_compressed(one), "Single byte is not compressed")

    print("PASS\n")

fn test_compression_ratio(): void =>
    print("test_compression_ratio: ")

    var ratio: double = zlib.compression_ratio(1000, 250)
    assert(ratio == 25.0, "250/1000 should be 25%")

    var saved: double = zlib.space_saved(1000, 250)
    assert(saved == 75.0, "Should save 75%")

    // Edge case: zero original size
    var zero_ratio: double = zlib.compression_ratio(0, 0)
    assert(zero_ratio == 0.0, "Zero size should give 0 ratio")

    print("PASS\n")

fn test_error_messages(): void =>
    print("test_error_messages: ")

    assert(zlib.error_message(zlib.ZLIB_OK()) == "OK", "ZLIB_OK message")
    assert(zlib.error_message(zlib.ZLIB_DATA_ERROR()) == "Data error (corrupted or incomplete)", "ZLIB_DATA_ERROR message")
    assert(zlib.error_message(zlib.ZLIB_MEM_ERROR()) == "Memory error", "ZLIB_MEM_ERROR message")
    assert(zlib.error_message(zlib.ZLIB_BUF_ERROR()) == "Buffer error (output too small)", "ZLIB_BUF_ERROR message")

    print("PASS\n")

fn test_compressible_data(): void =>
    print("test_compressible_data: ")

    // Repeated pattern - compresses well
    var data: byte[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9}

    // Compress
    var compressed: byte[] = zlib.compress_data(data)
    assert(compressed.length > 0, "Should compress")

    // Decompress
    var decompressed: byte[] = zlib.decompress_data(compressed, data.length)
    assert(decompressed.length == data.length, "Should restore original size")

    // Verify
    var i: int = 0
    while i < data.length =>
        assert(decompressed[i] == data[i], "Data should match after roundtrip")
        i = i + 1

    print("PASS\n")

fn test_random_like_data(): void =>
    print("test_random_like_data: ")

    // Data with less pattern - still works but may not compress well
    var data: byte[] = {173, 59, 232, 149, 66, 239, 156, 73, 246, 163}

    // Should still work even if it expands slightly
    var compressed: byte[] = zlib.compress_data(data)
    assert(compressed.length > 0, "Should still produce output")

    var decompressed: byte[] = zlib.decompress_data(compressed, 10)
    assert(decompressed.length == 10, "Should restore original size")

    // Verify content
    var i: int = 0
    while i < 10 =>
        assert(decompressed[i] == data[i], "Content should match")
        i = i + 1

    print("PASS\n")

fn main(): void =>
    print("=== SDK Compression Tests ===\n\n")

    test_basic_compress_decompress()
    test_compress_levels()
    test_compress_to_buffer()
    test_empty_data()
    test_is_compressed()
    test_compression_ratio()
    test_error_messages()
    test_compressible_data()
    test_random_like_data()

    print("\nAll compression tests passed!\n")
