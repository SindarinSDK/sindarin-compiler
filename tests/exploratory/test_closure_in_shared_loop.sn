// Test 87: Closures capturing variables in shared loops
// Tests arena lifetime when closures are created in shared for loops

fn main(): int =>
    print("Test closures in shared loops:\n\n")

    // Test 1: Closure created in shared loop - captures and returns value
    print("Test 1 - Closure in shared for:\n")
    var captured_sum: int = 0
    var last_closure: fn(): int = fn(): int => 0

    shared for i in 1..4 =>
        var local_val: int = i * 10
        var closure: fn(): int = fn(): int => local_val
        captured_sum = captured_sum + closure()
        last_closure = closure

    print($"  Sum during loop: {captured_sum}\n")
    print($"  Last closure returns: {last_closure()}\n")

    // Test 2: Shared while loop with closure
    print("\nTest 2 - Closure in shared while:\n")
    var getter1: fn(): int = fn(): int => 0
    var getter2: fn(): int = fn(): int => 0
    var getter3: fn(): int = fn(): int => 0

    var k: int = 0
    shared while k < 3 =>
        var num: int = k + 100
        var getter: fn(): int = fn(): int => num
        if k == 0 =>
            getter1 = getter
        if k == 1 =>
            getter2 = getter
        if k == 2 =>
            getter3 = getter
        k = k + 1

    print($"  Getter 0: {getter1()}\n")
    print($"  Getter 1: {getter2()}\n")
    print($"  Getter 2: {getter3()}\n")

    // Test 3: Modifying outer variable from closure in shared loop
    print("\nTest 3 - Outer modification in shared loop:\n")
    var total: int = 0

    // Create closures that add to total
    var adder1: fn(): int = fn(): int =>
        total = total + 1
        return total
    var adder2: fn(): int = fn(): int =>
        total = total + 2
        return total
    var adder3: fn(): int = fn(): int =>
        total = total + 3
        return total
    var adder4: fn(): int = fn(): int =>
        total = total + 4
        return total

    print($"  Total before calling adders: {total}\n")
    print($"  adder1(): {adder1()}\n")
    print($"  adder2(): {adder2()}\n")
    print($"  adder3(): {adder3()}\n")
    print($"  adder4(): {adder4()}\n")
    print($"  Total after calling adders: {total}\n")

    print("\nAll shared loop closure tests passed!\n")
    return 0
