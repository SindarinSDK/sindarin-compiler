// Code Generation Test: 3 Nested Loop Arena Escape (Shared, Chained)
//
// Tests that string values are allocated directly in caller's arena
// when using shared functions and loops - no promotion needed.

shared fn build_chained(): str =>
    var result: str = ""
    shared for var i: int = 1; i <= 2; i++ =>
        var outer: str = ""
        shared for var j: int = 1; j <= 2; j++ =>
            var middle: str = ""
            shared for var k: int = 1; k <= 2; k++ =>
                var inner: str = $"[d4:i={i},j={j},k={k}]"
                // No escape needed - all in same arena
                middle = middle + inner + "->d3 "
            // No escape needed - all in same arena
            outer = outer + "(" + middle + ")->d2 "
        // No escape needed - all in same arena
        result = result + "<" + outer + ">->d1\n"
    return result

fn main(): int =>
    println("Shared chained test (3 loops):")
    println("All values allocated directly in caller arena")
    println(build_chained())
    println("PASS: All shared allocations succeeded")
    return 0
