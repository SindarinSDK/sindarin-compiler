// Code Generation Test: 3 Nested Loop Arena Escape (Shared, Jump)
//
// Tests that with shared functions and loops, all allocations
// go directly to the caller's arena - no jump escapes needed.

shared fn build_with_jumps(): str =>
    var to_d1: str = ""
    shared for var i: int = 1; i <= 2; i++ =>
        var to_d2: str = ""
        shared for var j: int = 1; j <= 2; j++ =>
            var to_d3: str = ""
            shared for var k: int = 1; k <= 2; k++ =>
                // All allocations in same arena - no jumps
                var tag: str = $"[i={i},j={j},k={k}]"
                to_d3 = to_d3 + "d4->d3" + tag + " "
                to_d2 = to_d2 + "d4->d2" + tag + " "
                to_d1 = to_d1 + "d4->d1" + tag + " "
            to_d2 = to_d2 + "| collected_d3:(" + to_d3 + ") "
        to_d1 = to_d1 + "| collected_d2:(" + to_d2 + ")\n"
    return to_d1

fn main(): int =>
    println("Shared jump test (3 loops):")
    println("All values in same arena - no jump escapes needed")
    println(build_with_jumps())
    println("PASS: All shared allocations succeeded")
    return 0
